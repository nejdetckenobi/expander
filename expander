#!/usr/bin/env bash

USER_HOME="${HOME:-$(getent passwd "$(id -u)" | cut -d: -f6)}"

REGISTRY_DIR="$USER_HOME/.config/expander"
REGISTRY_FILE="$REGISTRY_DIR/registry.json"

mkdir -p "$REGISTRY_DIR"

if [ ! -f "$REGISTRY_FILE" ]; then
  echo "{}" > "$REGISTRY_FILE"
fi

CLIPBOARD_DATA=$(xclip -o -selection primary 2>/dev/null | sed 's/[[:space:]]*$//')
sleep 0.1


if [ -z "$CLIPBOARD_DATA" ]; then
  CLIPBOARD_DATA=$(xclip -o -selection clipboard 2>/dev/null | sed 's/[[:space:]]*$//')
fi

if [ -z "$CLIPBOARD_DATA" ]; then
  exit 0
fi

VALUE=$(jq -r --arg key "$CLIPBOARD_DATA" '.[$key] // empty' "$REGISTRY_FILE")


if [ -z "$VALUE" ]; then
  exit 0
fi

OLD_CLIPBOARD=$(xclip -o -selection clipboard 2>/dev/null)

echo -n "$VALUE" | xclip -selection clipboard
sleep 0.1

xdotool key ctrl+v

sleep 0.1

if [ -n "$OLD_CLIPBOARD" ]; then
  echo -n "$OLD_CLIPBOARD" | xclip -selection clipboard
fi

exit 0
